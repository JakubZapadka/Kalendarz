<style>
  #add_event {
    display: flex;
    flex-direction: column;
    gap: 1rem;
    background-color: var(--bg-200);
    padding: 2rem;
    border-radius: 1rem;
    box-shadow: inset 0 0 5px 0 var(--bg-300);
  }
  #add_event h2 {
    text-align: center;
  }
  #add_event input,
  #add_event #description,
  #add_event #date {
    text-align: left;
    background-color: inherit;
    border: none;
    padding: 0.4rem;
    font-size: 1rem;
    cursor: text;
  }
  #add_event #title {
    padding: 0.4rem 0;
    border-bottom: 1px solid var(--text-100);
    transition: border-bottom, 0.1s;
  }
  #add_event #title:focus {
    border-bottom: 1px solid var(--accent-100);
  }
  #add_event input:focus-visible,
  #add_event #description:focus-visible {
    outline: 0;
  }
  #add_event .textarea[contenteditable]:empty::before {
    content: "Dodaj opis";
    color: gray;
  }
  #add_event > div input:hover,
  #add_event > div input:focus,
  #add_event #description:hover,
  #add_event #description:focus {
    background-color: var(--bg-300);
    border-radius: 0.2rem;
  }
  #add_event button {
    color: var(--bg-100);
    background-color: var(--primary-100);
    padding: 1rem;
    border: none;
    cursor: pointer;
    border-radius: 0.5rem;
    transition: background-color 0.1s;
  }
  #add_event button:hover {
    background-color: var(--accent-200);
  }
  #add_event > div {
    display: grid;
    grid-template-columns: auto auto;
    text-align: center;
    gap: 0.5rem;
  }
  #add_event i {
    align-self: center;
  }

  #add_event .error {
    color: red;
    font-size: 0.8rem;
    text-align: left;
  }
  #add_event #date_err,
  #add_event #duration_err {
    grid-column: span 2;
  }
  #add_event .error:empty {
    display: none;
  }
  input[type="datetime-local"]::-webkit-calendar-picker-indicator {
    cursor: pointer;
  }
</style>

<form id="add_event">
  <h2>Nowe wydarzenie</h2>
  <input
    type="text"
    id="title"
    name="title"
    placeholder="Dodaj tytuł"
    autocomplete="off"
    required
  />
  <span id="title_err" class="error"></span>
  <div>
    <i class="fa-regular fa-clock"></i>
    <input type="datetime-local" id="date" name="date" required />
    <span id="date_err" class="error"></span>

    <i class="fa-solid fa-hourglass"></i>
    <input
      type="number"
      id="duration"
      name="duration"
      placeholder="Dodaj czas trwania (min)"
      required
    />
    <span id="duration_err" class="error"></span>

    <i class="fa-regular fa-map"></i>
    <input
      type="text"
      id="location"
      name="location"
      placeholder="Dodaj lokalizację"
    />

    <i class="fa-solid fa-quote-right"></i>
    <span
      class="textarea"
      role="textbox"
      name="description"
      id="description"
      contenteditable
    ></span>
  </div>

  <button onclick="addEvent()" type="button"><h3>Dodaj wydarzenie</h3></button>
</form>

<script>
  const desc_width = document.querySelector(
    "#add_event #description"
  ).clientWidth;
  document.querySelector("#add_event #description").style.maxWidth =
    desc_width + "px";
  let currentlyAddedEvents = [];
  function addEvent() {
    const title = document.querySelector("#add_event #title").value;
    const date = document.querySelector("#add_event #date").value;
    const duration = parseInt(
      document.querySelector("#add_event #duration").value
    );
    const location = document.querySelector("#add_event #location").value;
    const description = document.querySelector(
      "#add_event #description"
    ).textContent;

    //VALIDATION
    const title_err = document.querySelector("#add_event #title_err");
    const date_err = document.querySelector("#add_event #date_err");
    const duration_err = document.querySelector("#add_event #duration_err");

    //SENDING EVENT
    if (
      validation(
        title,
        title_err,
        date,
        date_err,
        duration,
        duration_err,
        location,
        description
      )
    ) {
      fetch("./events/save_event.php", {
        method: "POST",
        headers: {
          "Content-Type": "application/x-www-form-urlencoded",
        },
        body:
          "action=add" +
          "&title=" +
          title +
          "&date=" +
          date +
          "&duration=" +
          duration +
          "&location=" +
          location +
          "&description=" +
          description,
      })
        .then((res) => res.json())
        .then((data) => {
          currentlyAddedEvents.push(data.Object);
          calendar.fetchData();
        })
        .catch((error) => console.log("Błąd:", error));
    }
  }
  function validation(
    ftitle,
    ftitle_err,
    fdate,
    fdate_err,
    fduration,
    fduration_err,
    flocation,
    fdescription
  ) {
    const initialDate = new Date(fdate);
    const initialTimeInMinutes =
      initialDate.getHours() * 60 + initialDate.getMinutes();

    if (
      ftitle == "" ||
      fdate == "" ||
      isNaN(fduration) ||
      fduration <= 0 ||
      initialTimeInMinutes + fduration > 1440
    ) {
      if (ftitle == "") {
        ftitle_err.textContent = "Błędny tytuł";
      } else {
        ftitle_err.textContent = "";
      }
      if (fdate == "") {
        fdate_err.textContent = "Błędna data";
      } else {
        fdate_err.textContent = "";
      }
      if (fduration == "" || fduration <= 0) {
        fduration_err.textContent = "Błędny czas trwania";
      } else if (parseInt(initialTimeInMinutes) + parseInt(fduration) > 1440) {
        fduration_err.innerHTML =
          "Czas trwania nie może wykraczać<br> poza konkretny dzień";
      } else {
        fduration_err.textContent = "";
      }
      return false;
    } else {
      ftitle_err.textContent = "";
      fdate_err.textContent = "";
      fduration_err.textContent = "";
    }
    return true;
  }
</script>
